<app-base-data-table
  [tableId]="'results-table'"
  [columns]="columns"
  [dataSource]="dataSource"
  [queryParams]="tableQueryParams"
  [expandable]="true"
  [maxTableHeight]="'500px'"
  (queryParamsChange)="onTableQueryChange($event)"
  (rowExpand)="onRowExpand($event)"
>
  <!-- Custom cell rendering -->
  <ng-template #cellTemplate let-column="column" let-row="row">
    <ng-container [ngSwitch]="column.key">
      <!-- Data Source badge -->
      <nz-tag *ngSwitchCase="'data_source'" [nzColor]="'blue'">
        {{ $any(row).data_source }}
      </nz-tag>

      <!-- Vehicle ID (small monospace) -->
      <small *ngSwitchCase="'vehicle_id'" class="vehicle-id">
        {{ $any(row).vehicle_id }}
      </small>

      <!-- Default rendering -->
      <span *ngSwitchDefault>
        {{ $any(row)[column.key] }}
      </span>
    </ng-container>
  </ng-template>

  <!-- Expansion content (VIN instances) -->
  <ng-template #expansionTemplate let-row="row">
    <div class="expansion-content">
      <nz-spin [nzSpinning]="isLoadingInstances($any(row).vehicle_id)">
        <div
          *ngIf="
            getInstances($any(row).vehicle_id).length > 0;
            else noInstances
          "
        >
          <h4>Synthetic VIN Instances (Sample of 8)</h4>
          <nz-table
            #instancesTable
            [nzData]="getInstances($any(row).vehicle_id)"
            [nzPageSize]="8"
            [nzShowPagination]="false"
            nzSize="small"
            class="instances-table"
          >
            <thead>
              <tr>
                <th>VIN</th>
                <th>Condition</th>
                <th>Mileage</th>
                <th>State</th>
                <th>Title Status</th>
                <th>Color</th>
                <th>Est. Value</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let instance of instancesTable.data">
                <td>
                  <code>{{ instance.vin }}</code>
                  <small *ngIf="instance.matching_numbers"
                    >âœ" Matching Numbers</small
                  >
                </td>
                <td>
                  {{ instance.condition_rating }}/10
                  <small>{{ instance.condition_description }}</small>
                </td>
                <td>
                  {{ instance.mileage | number }}
                  <small *ngIf="instance.mileage_verified">âœ" Verified</small>
                </td>
                <td>
                  {{ instance.registered_state }}
                  <small>{{ instance.registration_status }}</small>
                </td>
                <td>
                  <nz-tag
                    [nzColor]="getTitleStatusColor(instance.title_status)"
                  >
                    {{ instance.title_status }}
                  </nz-tag>
                </td>
                <td>{{ instance.exterior_color }}</td>
                <td>{{ instance.estimated_value | currency }}</td>
              </tr>
            </tbody>
          </nz-table>
        </div>

        <ng-template #noInstances>
          <div class="no-instances">
            <i nz-icon nzType="inbox" nzTheme="outline"></i>
            <p>No instances available</p>
          </div>
        </ng-template>
      </nz-spin>
    </div>
  </ng-template>
</app-base-data-table>
