<div class="results-table-container">
  <!-- Header with count, clear filters, and reset columns -->
  <div class="results-header" *ngIf="!loading && currentModelCombos.length > 0">
    <div class="header-left">
      <h3>Vehicle Details</h3>
      <span class="results-count" *ngIf="results.length > 0"
        >{{ results.length }} of {{ total }} results</span
      >
      <span class="results-count" *ngIf="results.length === 0"
        >0 results found</span
      >
    </div>
    <div class="header-actions">
      <button
        class="btn-reset-columns"
        (click)="resetColumnOrder()"
        nz-tooltip
        nzTooltipTitle="Reset column order to default"
      >
        Reset Columns
      </button>
      <button
        *ngIf="
          manufacturerFilter ||
          modelFilter ||
          yearMinFilter ||
          yearMaxFilter ||
          bodyClassFilter ||
          dataSourceFilter
        "
        class="btn-clear-filters"
        (click)="clearAllFilters()"
      >
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <nz-spin [nzSpinning]="loading" nzTip="Loading vehicle details...">
    <!-- Error State -->
    <nz-alert
      *ngIf="error"
      nzType="error"
      [nzMessage]="error"
      nzShowIcon
      nzCloseable
      (nzOnClose)="error = null"
      class="error-alert"
    >
    </nz-alert>

    <!-- Empty State: No Models Selected -->
    <nz-empty
      *ngIf="!loading && !error && currentModelCombos.length === 0"
      nzNotFoundContent="No vehicles selected. Use the picker above to select manufacturer-model combinations."
      class="empty-state"
    >
    </nz-empty>

    <!-- Results Table (always rendered when models selected, shows empty message when no results) -->
    <nz-table
      *ngIf="!error && currentModelCombos.length > 0"
      #resultsTable
      [nzData]="results"
      [nzFrontPagination]="false"
      [nzTotal]="total"
      [nzPageIndex]="currentPage"
      [nzPageSize]="pageSize"
      [nzShowSizeChanger]="results.length > 0"
      [nzShowPagination]="results.length > 0"
      [nzPageSizeOptions]="[10, 20, 50, 100]"
      (nzPageIndexChange)="onPageChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzScroll]="{ y: '1750px' }"
      nzSize="middle"
      nzBordered
      [nzTemplateMode]="true"
    >
      <thead>
        <!-- Column Headers Row (Draggable) -->
        <tr
          cdkDropList
          cdkDropListOrientation="horizontal"
          (cdkDropListDropped)="onColumnDrop($event)"
        >
          <th nzWidth="50px" class="expand-column"></th>
          <th
            *ngFor="let column of columns"
            [nzWidth]="column.width"
            [nzSortFn]="column.sortable && results.length > 0"
            (nzSortOrderChange)="column.sortable ? onSort(column.key) : null"
            [nzSortOrder]="
              sortColumn === column.key
                ? sortDirection === 'asc'
                  ? 'ascend'
                  : sortDirection === 'desc'
                  ? 'descend'
                  : null
                : null
            "
            cdkDrag
            [cdkDragData]="column"
            (cdkDragStarted)="onColumnDragStart($event)"
            (mousedown)="onHeaderMouseDown($event)"
            class="draggable-header"
          >
            <div class="header-content">
              <span class="column-label">{{ column.label }}</span>
              <i
                nz-icon
                nzType="drag"
                nzTheme="outline"
                class="drag-handle"
              ></i>
            </div>
          </th>
        </tr>

        <!-- Filter Row -->
        <tr class="filter-row">
          <th></th>
          <th *ngFor="let column of columns">
            <!-- Text Filter -->
            <input
              *ngIf="column.filterable && column.filterType === 'text'"
              nz-input
              placeholder="Filter..."
              [value]="getFilterValue(column.key)"
              (input)="onFilterChange(column.key, $any($event.target).value)"
              class="filter-input"
            />

            <!-- Year Range Filter -->
            <div
              *ngIf="column.filterable && column.filterType === 'year-range'"
              class="year-filter"
            >
              <input
                nz-input
                placeholder="Min"
                type="number"
                [value]="yearMinFilter"
                (input)="onYearMinFilterChange($any($event.target).value)"
                (change)="onYearMinFilterBlur()"
                (blur)="onYearMinFilterBlur()"
                (keyup.enter)="onYearMinFilterBlur()"
                class="filter-input year-input"
              />
              <input
                nz-input
                placeholder="Max"
                type="number"
                [value]="yearMaxFilter"
                (input)="onYearMaxFilterChange($any($event.target).value)"
                (change)="onYearMaxFilterBlur()"
                (blur)="onYearMaxFilterBlur()"
                (keyup.enter)="onYearMaxFilterBlur()"
                class="filter-input year-input"
              />
            </div>
          </th>
        </tr>
      </thead>

      <tbody>
        <!-- Empty state row (when no results) -->
        <tr *ngIf="results.length === 0">
          <td
            [attr.colspan]="columns.length + 1"
            style="text-align: center; padding: 40px"
          >
            <nz-empty
              nzNotFoundContent="No vehicles match your current filters. Try adjusting the filter criteria above."
              [nzNotFoundImage]="'simple'"
            >
            </nz-empty>
          </td>
        </tr>

        <!-- Data rows (when we have results) -->
        <ng-container
          *ngFor="let vehicle of resultsTable.data; trackBy: trackByVehicleId"
        >
          <tr>
            <td
              [nzExpand]="expandSet.has(vehicle.vehicle_id)"
              (nzExpandChange)="onExpandChange(vehicle.vehicle_id, $event)"
            ></td>
            <td *ngFor="let column of columns">
              <!-- Manufacturer -->
              <span *ngIf="column.key === 'manufacturer'">{{
                vehicle.manufacturer
              }}</span>

              <!-- Model -->
              <span *ngIf="column.key === 'model'">{{ vehicle.model }}</span>

              <!-- Year -->
              <span *ngIf="column.key === 'year'">{{ vehicle.year }}</span>

              <!-- Body Class -->
              <span *ngIf="column.key === 'body_class'">{{
                vehicle.body_class || "N/A"
              }}</span>

              <!-- Data Source -->
              <nz-tag
                *ngIf="column.key === 'data_source'"
                [nzColor]="
                  vehicle.data_source === 'nhtsa_vpic_large_sample'
                    ? 'blue'
                    : 'default'
                "
              >
                {{ vehicle.data_source }}
              </nz-tag>

              <!-- Vehicle ID -->
              <small *ngIf="column.key === 'vehicle_id'" class="vehicle-id">{{
                vehicle.vehicle_id
              }}</small>
            </td>
          </tr>
          <tr [nzExpand]="expandSet.has(vehicle.vehicle_id)">
            <td
              [attr.colspan]="columns.length + 1"
              class="expanded-row-content"
            >
              <div class="vehicle-instances">
                <h4>Vehicle Instances (VIN Data)</h4>

                <!-- Loading state -->
                <div
                  *ngIf="isLoadingInstances(vehicle.vehicle_id)"
                  class="instances-loading"
                >
                  <nz-spin nzSimple></nz-spin>
                  <span>Loading VIN data...</span>
                </div>

                <!-- Instances table -->
                <nz-table
                  *ngIf="
                    !isLoadingInstances(vehicle.vehicle_id) &&
                    getInstances(vehicle.vehicle_id).length > 0
                  "
                  [nzData]="getInstances(vehicle.vehicle_id)"
                  [nzShowPagination]="false"
                  nzSize="small"
                  class="instances-table"
                >
                  <thead>
                    <tr>
                      <th>VIN</th>
                      <th>Condition</th>
                      <th>Mileage</th>
                      <th>State</th>
                      <th>Title Status</th>
                      <th>Color</th>
                      <th>Est. Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="let instance of getInstances(vehicle.vehicle_id)"
                    >
                      <td>
                        <code>{{ instance.vin }}</code>
                      </td>
                      <td>
                        <nz-rate
                          [ngModel]="instance.condition_rating"
                          [nzDisabled]="true"
                          [nzCount]="5"
                        >
                        </nz-rate>
                        <small>{{ instance.condition_description }}</small>
                      </td>
                      <td>
                        {{ instance.mileage | number }}
                        <nz-tag
                          *ngIf="instance.mileage_verified"
                          nzColor="green"
                          style="margin-left: 4px"
                        >
                          Verified
                        </nz-tag>
                      </td>
                      <td>{{ instance.registered_state }}</td>
                      <td>
                        <nz-tag
                          [nzColor]="getTitleStatusColor(instance.title_status)"
                        >
                          {{ instance.title_status }}
                        </nz-tag>
                      </td>
                      <td>{{ instance.exterior_color }}</td>
                      <td>${{ instance.estimated_value | number }}</td>
                    </tr>
                  </tbody>
                </nz-table>

                <!-- No data state -->
                <nz-empty
                  *ngIf="
                    !isLoadingInstances(vehicle.vehicle_id) &&
                    getInstances(vehicle.vehicle_id).length === 0
                  "
                  nzNotFoundContent="No VIN data available"
                  [nzNotFoundImage]="'simple'"
                >
                </nz-empty>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </nz-table>
  </nz-spin>
</div>
