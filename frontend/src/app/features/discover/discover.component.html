<div class="workspace-container">
  <div class="workspace-header">
    <div>
      <h2>Discover Vehicles</h2>
      <p class="subtitle">Drag panels between grids. Layout is saved automatically.</p>
    </div>
    <div class="actions">
      <div class="filters-summary" *ngIf="hasActiveFilters">
        <span class="summary-label">Active:</span>
        <span class="summary-count">{{ selectionCount }} model(s)</span>
        <button nz-button nzType="primary" nzDanger nzSize="small" (click)="onClearAll()">
          Clear All
        </button>
      </div>
    </div>
  </div>

  <div class="grids-container">
    <!-- Dynamic Grid Rendering -->
    <div
      *ngFor="let grid of grids; let i = index"
      class="grid-wrapper"
      [attr.data-grid-id]="grid.id"
      [style.border-color]="grid.borderColor">

      <gridster [options]="grid.options">
        <gridster-item *ngFor="let item of grid.items" [item]="item">
          <div class="panel-container">
            <div class="panel-header drag-handle">
              <span class="panel-title">
                <i nz-icon nzType="drag" nzTheme="outline"></i>
                <ng-container [ngSwitch]="item.panelType">
                  <ng-container *ngSwitchCase="'picker'">Model Picker</ng-container>
                  <ng-container *ngSwitchCase="'results'">Vehicle Results</ng-container>
                  <ng-container *ngSwitchCase="'query-control'">Query Control</ng-container>
                  <ng-container *ngSwitchCase="'plotly-charts'">Interactive Charts (Plotly)</ng-container>
                  <ng-container *ngSwitchDefault>Panel</ng-container>
                </ng-container>
              </span>
              <div class="panel-actions">
                <i
                  nz-icon
                  nzType="export"
                  nzTheme="outline"
                  nz-tooltip="Pop out to new window"
                  (click)="popOutPanel(grid.id, item); $event.stopPropagation()"
                  class="action-icon popout-icon"
                ></i>
                <i
                  nz-icon
                  [nzType]="item.panelType === 'picker' ? (getPanelCollapseState(grid.id) ? 'down' : 'up') : 'close'"
                  nzTheme="outline"
                  (click)="item.panelType === 'picker' ? togglePanelCollapse(grid.id) : removePanel(item, grid.id)"
                  class="action-icon"
                ></i>
              </div>
            </div>
            <div class="panel-content no-drag" [hidden]="item.panelType === 'picker' && getPanelCollapseState(grid.id)">
              <!-- Dynamic panel content based on panelType -->
              <div *ngIf="item.panelType === 'query-control'">
                <app-query-control (filterAdd)="onFilterAdd($event)"></app-query-control>
              </div>
              <div *ngIf="item.panelType === 'picker'">
                <app-table-picker></app-table-picker>
              </div>
              <div *ngIf="item.panelType === 'results'">
                <app-results-table></app-results-table>
              </div>
              <div *ngIf="item.panelType === 'plotly-charts'">
                <app-plotly-histogram></app-plotly-histogram>
              </div>
            </div>
          </div>
        </gridster-item>
      </gridster>
    </div>
  </div>

  <!-- Statistics Section -->
  <section *ngIf="statistics" class="statistics-section">
    <h2>Distribution Statistics</h2>

    <div class="histograms-grid">
      <!-- Chart 1: Vehicles by Manufacturer -->
      <app-histogram
        [title]="'Vehicles by Manufacturer'"
        [data]="manufacturerHistogramData"
        [clickable]="true"
        [selectedLabel]="selectedManufacturer"
        [maxHeight]="'400px'"
        (barClick)="onManufacturerBarClick($event)"
      ></app-histogram>

      <!-- Chart 2: Models by Manufacturer -->
      <app-histogram
        [title]="'Models by Manufacturer'"
        [data]="modelsHistogramData"
        [clickable]="false"
        [maxHeight]="'400px'"
      ></app-histogram>

      <!-- Chart 3: Vehicles by Year Range -->
      <app-histogram
        [title]="'Vehicles by Year Range'"
        [data]="yearRangeHistogramData"
        [clickable]="true"
        [selectedLabel]="selectedYearRange"
        [maxHeight]="'400px'"
        (barClick)="onYearRangeBarClick($event)"
      ></app-histogram>

      <!-- Chart 4: Vehicles by Body Class -->
      <app-histogram
        [title]="'Vehicles by Body Class'"
        [data]="bodyClassHistogramData"
        [clickable]="true"
        [selectedLabel]="selectedBodyClass"
        [maxHeight]="'400px'"
        (barClick)="onBodyClassBarClick($event)"
      ></app-histogram>
    </div>
  </section>
</div>
