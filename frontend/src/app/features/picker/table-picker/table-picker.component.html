<div class="table-picker-container">
  <!-- BaseDataTable with expandable manufacturer rows -->
  <app-base-data-table
    [tableId]="'table-picker'"
    [columns]="columns"
    [dataSource]="dataSource"
    [queryParams]="tableQueryParams"
    [expandable]="true"
    (queryParamsChange)="onTableQueryChange($event)"
    (rowExpand)="onRowExpand($event)"
  >
    <!-- Custom cell rendering for manufacturer rows -->
    <ng-template #cellTemplate let-column="column" let-row="row">
      <ng-container [ngSwitch]="column.key">
        <!-- Manufacturer column with parent checkbox -->
        <ng-container *ngSwitchCase="'manufacturer'">
          <label
            nz-checkbox
            [nzIndeterminate]="
              getManufacturerCheckboxState($any(row)) === 'indeterminate'
            "
            [nzChecked]="getManufacturerCheckboxState($any(row)) === 'checked'"
            (nzCheckedChange)="onManufacturerCheckboxChange($any(row), $event)"
            (click)="$event.stopPropagation()"
          >
            <strong>{{ $any(row).manufacturer }}</strong>
            <span
              class="selection-info"
              *ngIf="getSelectionCount($any(row).manufacturer) > 0"
            >
              ({{ getSelectionCount($any(row).manufacturer) }} of
              {{ $any(row).modelCount }} selected)
            </span>
          </label>
        </ng-container>

        <!-- Model column - empty for manufacturer summary rows -->
        <span *ngSwitchCase="'model'">
          <!-- Empty - models shown in expansion -->
        </span>

        <!-- Default rendering -->
        <span *ngSwitchDefault>
          {{ $any(row)[column.key] }}
        </span>
      </ng-container>
    </ng-template>

    <!-- Expansion content: model checkboxes -->
    <!-- Expansion content: model checkboxes in table format -->
    <ng-template #expansionTemplate let-row="row">
      <div class="expansion-content">
        <nz-table
          #modelsTable
          [nzData]="$any(row).models"
          [nzShowPagination]="false"
          nzSize="small"
          class="models-table"
        >
          <tbody>
            <tr *ngFor="let model of modelsTable.data">
              <!-- Manufacturer column (repeated for each model) -->
              <td class="manufacturer-cell">
                <label
                  nz-checkbox
                  [nzIndeterminate]="
                    getManufacturerCheckboxState($any(row)) === 'indeterminate'
                  "
                  [nzChecked]="
                    getManufacturerCheckboxState($any(row)) === 'checked'
                  "
                  (nzCheckedChange)="
                    onManufacturerCheckboxChange($any(row), $event)
                  "
                  (click)="$event.stopPropagation()"
                >
                  <strong>{{ $any(row).manufacturer }}</strong>
                </label>
              </td>

              <!-- Model column (individual model checkbox) -->
              <td class="model-cell">
                <label
                  nz-checkbox
                  [nzChecked]="
                    isModelSelected($any(row).manufacturer, model.model)
                  "
                  (nzCheckedChange)="
                    onModelCheckboxChange(
                      $any(row).manufacturer,
                      model.model,
                      $event
                    )
                  "
                  (click)="$event.stopPropagation()"
                >
                  {{ model.model }}
                </label>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </div>
    </ng-template>
  </app-base-data-table>

  <!-- Selected items display -->
  <div class="selections-display" *ngIf="selectedItems.length > 0">
    <div class="selections-header">
      <span class="selections-count">{{ selectedItems.length }} selected</span>
      <button nz-button nzType="link" nzSize="small" (click)="onClear()">
        Clear all
      </button>
    </div>

    <div class="selections-chips">
      <nz-tag
        *ngFor="let item of selectedItems"
        nzMode="closeable"
        (nzOnClose)="onRemoveModel(item)"
        class="selection-chip"
      >
        {{ item.manufacturer }} - {{ item.model }}
      </nz-tag>
    </div>
  </div>

  <!-- Action buttons -->
  <div class="actions-section">
    <button
      nz-button
      nzType="primary"
      nzSize="large"
      (click)="onApply()"
      [disabled]="selectedItems.length === 0"
    >
      <i nz-icon nzType="check-circle" nzTheme="outline"></i>
      Apply ({{ selectedItems.length }})
    </button>

    <button
      nz-button
      nzType="default"
      nzSize="large"
      (click)="onClear()"
      [disabled]="selectedItems.length === 0"
    >
      <i nz-icon nzType="close-circle" nzTheme="outline"></i>
      Clear
    </button>
  </div>
</div>
